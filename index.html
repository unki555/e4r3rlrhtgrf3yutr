<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Case App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #20272F;
            --card-bg: #2D3947;
            --wheel-bg: #3F4C5C;
            --menu-bg: rgba(32, 39, 47, 0.95);
            --text-color: white;
            --accent-color: #0197EC;
            --price-color: #FFFFF;
            --search-bg: rgba(255, 255, 255, 0.1);
            --success-color: #4CAF50;
            --warning-color: #CD1A03;
            --button-bg: rgba(255, 255, 255, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            padding-bottom: 80px;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            height: 100%;
            overflow-y: auto;
        }
        
        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--primary-bg);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .balance {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            background-color: rgba(19, 20, 24, 0.7);
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .coin-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }
        
        .deposit-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .deposit-btn:hover {
            background-color: #0280d0;
        }
        
        /* Search */
        .search-container {
            padding: 10px 16px;
            position: sticky;
            top: 68px;
            z-index: 99;
            background-color: var(--primary-bg);
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            background-color: var(--search-bg);
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Cases Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* Увеличили расстояние между карточками */
            padding: 16px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            height: 280px; /* Увеличили высоту карточек */
        }
        
        .card:hover {
            transform: translateY(-3px);
        }
        
        .card-image-container {
            width: 100%;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .card-image {
            width: 100%;
            height: 150px; /* Увеличили размер изображений */
            object-fit: contain;
        }
        
        .card-details {
            padding: 16px;
            text-align: center;
            min-height: 70px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .card-name {
            font-weight: 600;
            font-size: 16px;
            margin: 0 0 8px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-price {
            color: var(--price-color);
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Case Opening Modal */
        .case-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary-bg);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .case-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .case-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .case-close {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            background: none;
            border: none;
        }
        
        .wheel-container {
            width: 100%;
            background-color: var(--wheel-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            height: 220px;
        }
        
        /* Вертикальный ползунок по центру */
        .wheel-pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 100%;
            background: var(--accent-color);
            z-index: 10;
            box-shadow: 0 0 10px rgba(1, 151, 236, 0.7);
        }
        
        .wheel {
            display: flex;
            height: 100%;
        }
        
        .wheel-item {
            min-width: 150px;
            height: 100%;
            margin: 0 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
        
        .wheel-item.highlight {
            animation: highlight-item 1.5s ease-in-out;
            box-shadow: 0 0 15px var(--accent-color);
        }
        
        @keyframes highlight-item {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .wheel-item-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        .wheel-item-name {
            margin-top: 8px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .spin-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 0 20px 0;
            width: 100%;
            max-width: 300px;
            transition: transform 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        
        .spin-btn:disabled {
            background-color: gray;
            cursor: not-allowed;
        }
        
        .spin-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .possible-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            padding: 0 10px;
        }
        
        .possible-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
        }
        
        .possible-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        
        .possible-item-name {
            font-size: 12px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Payment Modal */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary-bg);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .payment-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .payment-title {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .amount-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .amount-option {
            background-color: var(--primary-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .amount-option.selected {
            border-color: var(--accent-color);
            background-color: rgba(1, 151, 236, 0.2);
        }
        
        .amount-value {
            font-weight: 700;
            font-size: 18px;
        }
        
        .amount-bonus {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .payment-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .payment-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }
        
        .payment-btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .payment-btn-secondary {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Won Item Modal */
        .won-item-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary-bg);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .won-item-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 30px 20px;
            width: 100%;
            max-width: 300px;
        }
        
        .won-item-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .won-item-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 0 auto 15px;
            animation: won-item-pulse 2s infinite;
        }
        
        @keyframes won-item-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .won-item-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .won-item-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .won-item-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .won-item-btn.keep {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .won-item-btn.sell {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* Menu */
        .menu-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--menu-bg);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
        }
        
        .menu-item.active {
            color: var(--text-color);
        }
        
        .menu-icon {
            font-size: 20px;
            transition: all 0.2s ease;
        }
        
        /* Inventory */
        .inventory-container {
            padding: 16px;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .empty-inventory {
            text-align: center;
        }
        
        .empty-inventory-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .empty-inventory-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .inventory-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            width: 100%;
            align-items: stretch;
        }
        
        .inventory-item {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .inventory-item-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 12px;
        }
        
        .inventory-item-name {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .inventory-item-buttons {
            display: flex;
            gap: 8px;
            width: 100%;
            margin-top: auto;
        }
        
        .inventory-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background-color: var(--accent-color);
            color: white;
        }
        
        /* History */
        .history-container {
            padding: 16px;
        }
        
        .history-item {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .history-item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        
        .history-item-info {
            flex: 1;
        }
        
        .history-item-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .history-item-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }
        
        .history-item-price {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Profile Section */
        .profile-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 3px solid var(--accent-color);
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .profile-id {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 30px;
        }
        
        .profile-section {
            width: 100%;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: left;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: 16px;
            font-weight: 500;
        }
        
        .settings-value {
            font-size: 16px;
            color: var(--accent-color);
        }
        
        .language-selector {
            display: flex;
            gap: 10px;
            padding: 8px;
            background-color: var(--button-bg);
            border-radius: 8px;
        }
        
        .language-option {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .language-option.active {
            background-color: var(--accent-color);
            color: white;
        }
        
        .profile-deposit-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            margin-top: 20px;
        }
        
        /* Sections */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 360px) {
            .card-image-container {
                height: 120px;
            }
            
            .wheel-item {
                min-width: 140px;
            }
            
            .card-name {
                font-size: 14px;
            }
        }
        
        @media (min-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .inventory-items {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .possible-items {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Фикс для скроллинга */
        html, body {
            height: 100%;
            overflow: auto;
        }
        
        .section-content {
            min-height: calc(100vh - 180px);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <img src="https://via.placeholder.com/36" class="user-avatar" id="user-avatar" alt="User Avatar">
            <div class="user-name" id="user-name">User</div>
        </div>
        <div class="balance-container">
            <button class="deposit-btn" id="deposit-btn">+</button>
            <div class="balance">
                <span id="balance-value">0</span>
                <img src="stars.png" class="coin-icon" alt="Coin">
            </div>
        </div>
    </div>
    
    <!-- Search -->
    <div class="search-container" id="search-container">
        <input type="text" class="search-input" id="search-input" placeholder="Поиск кейсов...">
    </div>
    
    <!-- Cases Section -->
    <div class="section active" id="cases-section">
        <div class="cards-grid" id="cases-grid"></div>
    </div>
    
    <!-- Inventory Section -->
    <div class="section" id="inventory-section">
        <div class="inventory-container" id="inventory-container">
            <div class="empty-inventory" id="empty-inventory">
                <div class="empty-inventory-title">Упс... Пока предметов нет</div>
                <button class="empty-inventory-btn" id="fix-inventory-btn">Исправить!</button>
            </div>
            <div class="inventory-items" id="inventory-items" style="display: none;"></div>
        </div>
    </div>
    
    <!-- History Section -->
    <div class="section" id="history-section">
        <div class="history-container" id="history-container">
            <div class="empty-inventory" id="empty-history" style="display: none;">
                <div class="empty-inventory-title">История пуста</div>
                <button class="empty-inventory-btn" id="fix-history-btn">Открыть кейс!</button>
            </div>
            <div id="history-items"></div>
        </div>
    </div>
    
    <!-- Profile Section -->
    <div class="section" id="profile-section">
        <div class="profile-container">
            <img src="https://via.placeholder.com/120" class="profile-avatar" id="profile-avatar" alt="Profile Avatar">
            <div class="profile-name" id="profile-name">Имя Пользователя</div>
            <div class="profile-id" id="profile-id">ID: 123456789</div>
            
            <div class="profile-section">
                <div class="section-title">Настройки</div>
                <div class="settings-item">
                    <div class="settings-label">Язык</div>
                    <div class="language-selector">
                        <div class="language-option active">RU</div>
                        <div class="language-option">EN</div>
                    </div>
                </div>
            </div>
            
            <button class="profile-deposit-btn" id="profile-deposit-btn">
                Пополнить баланс
            </button>
        </div>
    </div>
    
    <!-- Case Opening Modal -->
    <div class="case-modal" id="case-modal">
        <div class="case-header">
            <div class="case-title" id="case-modal-title">Открытие кейса</div>
            <button class="case-close" id="close-case-modal">&times;</button>
        </div>
        
        <div class="wheel-container">
            <div class="wheel" id="wheel"></div>
            <!-- Вертикальный ползунок по центру -->
            <div class="wheel-pointer"></div>
        </div>
        
        <button class="spin-btn" id="spin-btn">Открыть за <span id="spin-price">0</span> <img src="stars.png" style="width:16px;height:16px;" alt="Coin"></button>
        
        <div class="possible-items" id="possible-items"></div>
    </div>
    
    <!-- Payment Modal -->
    <div class="payment-modal" id="payment-modal">
        <div class="payment-content">
            <div class="payment-title">Пополнение баланса</div>
            <div class="amount-selector">
                <div class="amount-option selected" data-amount="100">
                    <div class="amount-value">100</div>
                    <div class="amount-bonus">+0%</div>
                </div>
                <div class="amount-option" data-amount="200">
                    <div class="amount-value">200</div>
                    <div class="amount-bonus">+10%</div>
                </div>
                <div class="amount-option" data-amount="500">
                    <div class="amount-value">500</div>
                    <div class="amount-bonus">+20%</div>
                </div>
                <div class="amount-option" data-amount="1000">
                    <div class="amount-value">1000</div>
                    <div class="amount-bonus">+30%</div>
                </div>
            </div>
            <div class="payment-buttons">
                <button class="payment-btn payment-btn-secondary" id="cancel-payment">Отмена</button>
                <button class="payment-btn payment-btn-primary" id="confirm-payment">Оплатить</button>
            </div>
        </div>
    </div>
    
    <!-- Won Item Modal -->
    <div class="won-item-modal" id="won-item-modal">
        <div class="won-item-content">
            <div class="won-item-title">Поздравляем!</div>
            <img src="" class="won-item-image" id="won-item-image" alt="Выигранный предмет">
            <div class="won-item-name" id="won-item-name"></div>
            <div class="won-item-buttons">
                <button class="won-item-btn sell" id="sell-item">Продать за 100%</button>
                <button class="won-item-btn keep" id="keep-item">Оставить</button>
            </div>
        </div>
    </div>
    
    <!-- Menu -->
    <div class="menu-container">
        <div class="menu-item active" data-tab="cases-section">
            <div class="menu-icon">
                <i class="fasfa-gift"></i>
            </div>
            <div>Кейсы</div>
        </div>
        <div class="menu-item" data-tab="inventory-section">
            <div class="menu-icon">
                <i class="fas fa-inbox"></i>
            </div>
            <div>Инвентарь</div>
        </div>
        <div class="menu-item" data-tab="history-section">
            <div class="menu-icon">
                <i class="fas fa-history"></i>
            </div>
            <div>История</div>
        </div>
        <div class="menu-item" data-tab="profile-section">
            <div class="menu-icon">
                <i class="fas fa-user-circle"></i>
            </div>
            <div>Профиль</div>
        </div>
    </div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Инициализация Telegram WebApp
        const tgWebApp = window.Telegram.WebApp;
        
        // Данные кейсов
        const casesDatabase = [
            { 
                id: 1, 
                name: "Love CaseX", 
                price: 0, 
                image: "https://via.placeholder.com/300x200/2D3947/FFFFFF?text=God+XCase",
                items: [
                    { id: 1, name: "Cookie Heart", image: "cockieheart.png", chance: 10 },
                    { id: 2, name: "Snake Box", image: "snakebox.png", chance: 15 },
                    { id: 3, name: "Lol Pop", image: "lolpop.png", chance: 30 },
                    { id: 4, name: "Teddy", image: "teddybear.png", chance: 55 },
                    { id: 5, name: "Heart", image: "hert.png", chance: 55},
                ]
            },

        ];
        
        // Игровые данные
        let userBalance = 500;
        let selectedCase = null;
        let selectedDepositAmount = 100;
        let isSpinning = false;
        let wheelItems = [];
        let allPossibleItems = [];
        let inventoryData = JSON.parse(localStorage.getItem('userInventory')) || [];
        let historyData = JSON.parse(localStorage.getItem('userHistory')) || [];
        let currentSection = 'cases-section';
        let currentLanguage = localStorage.getItem('userLanguage') || 'RU';
        let lastWonItem = null;
        
        // Переводы интерфейса
        const translations = {
            RU: {
                cases: "Кейсы",
                inventory: "Инвентарь",
                history: "История",
                profile: "Профиль",
                search_placeholder: "Поиск кейсов...",
                empty_inventory: "Упс... Пока предметов нет",
                fix_inventory: "Исправить!",
                empty_history: "История пуста",
                fix_history: "Открыть кейс!",
                deposit: "Пополнить баланс",
                open_case: "Открытие кейса",
                open_for: "Открыть за",
                possible_items: "Возможные предметы",
                deposit_balance: "Пополнение баланса",
                cancel: "Отмена",
                pay: "Оплатить",
                congratulations: "Поздравляем!",
                sell_full: "Продать за 100%",
                keep: "Оставить",
                settings: "Настройки",
                language: "Язык",
                deposit_btn: "Пополнить баланс",
                sell_item: "Продать",
                withdraw_item: "Вывести"
            },
            EN: {
                cases: "Cases",
                inventory: "Inventory",
                history: "History",
                profile: "Profile",
                search_placeholder: "Search cases...",
                empty_inventory: "Oops... No items yet",
                fix_inventory: "Fix it!",
                empty_history: "History is empty",
                fix_history: "Open a case!",
                deposit: "Deposit balance",
                open_case: "Case opening",
                open_for: "Open for",
                possible_items: "Possible items",
                deposit_balance: "Balance deposit",
                cancel: "Cancel",
                pay: "Pay",
                congratulations: "Congratulations!",
                sell_full: "Sell for 100%",
                keep: "Keep",
                settings: "Settings",
                language: "Language",
                deposit_btn: "Deposit balance",
                sell_item: "Sell",
                withdraw_item: "Withdraw"
            }
        };
        
        // Применение текущего языка
        function applyLanguage() {
            document.getElementById('search-input').placeholder = translations[currentLanguage].search_placeholder;
            document.querySelector('.menu-item[data-tab="cases-section"] div').textContent = translations[currentLanguage].cases;
            document.querySelector('.menu-item[data-tab="inventory-section"] div').textContent = translations[currentLanguage].inventory;
            document.querySelector('.menu-item[data-tab="history-section"] div').textContent = translations[currentLanguage].history;
            document.querySelector('.menu-item[data-tab="profile-section"] div').textContent = translations[currentLanguage].profile;
            
            document.querySelector('#empty-inventory .empty-inventory-title').textContent = translations[currentLanguage].empty_inventory;
            document.getElementById('fix-inventory-btn').textContent = translations[currentLanguage].fix_inventory;
            document.querySelector('#empty-history .empty-inventory-title').textContent = translations[currentLanguage].empty_history;
            document.getElementById('fix-history-btn').textContent = translations[currentLanguage].fix_history;
            
            document.getElementById('profile-deposit-btn').textContent = translations[currentLanguage].deposit_btn;
            document.querySelector('.payment-title').textContent = translations[currentLanguage].deposit_balance;
            document.getElementById('cancel-payment').textContent = translations[currentLanguage].cancel;
            document.getElementById('confirm-payment').textContent = translations[currentLanguage].pay;
            
            document.querySelector('.won-item-title').textContent = translations[currentLanguage].congratulations;
            document.getElementById('sell-item').textContent = translations[currentLanguage].sell_full;
            document.getElementById('keep-item').textContent = translations[currentLanguage].keep;
            
            document.querySelector('.profile-section .section-title').textContent = translations[currentLanguage].settings;
            document.querySelector('.settings-item .settings-label').textContent = translations[currentLanguage].language;
            
            // Обновляем кнопки в инвентаре
            document.querySelectorAll('.inventory-btn.sell').forEach(btn => {
                btn.textContent = translations[currentLanguage].sell_item;
            });
            document.querySelectorAll('.inventory-btn.withdraw').forEach(btn => {
                btn.textContent = translations[currentLanguage].withdraw_item;
            });
        }
        
        // Инициализация приложения
        function initApp() {
            if (tgWebApp) {
                tgWebApp.expand();
                tgWebApp.ready();
                
                // Получаем данные пользователя
                const user = tgWebApp.initDataUnsafe?.user;
                if (user) {
                    document.getElementById('balance-value').textContent = userBalance;
                    
                    // Устанавливаем аватар и имя пользователя
                    if (user.photo_url) {
                        document.getElementById('user-avatar').src = user.photo_url;
                        document.getElementById('profile-avatar').src = user.photo_url;
                    }
                    
                    const userName = user.first_name || 'User';
                    document.getElementById('user-name').textContent = userName;
                    document.getElementById('profile-name').textContent = userName;
                    document.getElementById('profile-id').textContent = `ID: ${user.id || '123456789'}`;
                }
            }
            
            // Применяем язык
            applyLanguage();
            
            // Загружаем кейсы
            loadCases();
            
            // Загружаем инвентарь
            loadInventory();
            
            // Загружаем историю
            loadHistory();
            
            // Настройка обработчиков событий
            setupEventListeners();
        }
        
        // Загрузка кейсов
        function loadCases() {
            const casesGrid = document.getElementById('cases-grid');
            casesGrid.innerHTML = '';
            
            casesDatabase.forEach(caseItem => {
                const caseElement = document.createElement('div');
                caseElement.className = 'card';
                caseElement.setAttribute('data-id', caseItem.id);
                
                caseElement.innerHTML = `
                    <div class="card-image-container">
                        <img src="${caseItem.image}" class="card-image" alt="${caseItem.name}">
                    </div>
                    <div class="card-details">
                        <div class="card-name">${caseItem.name}</div>
                        <div class="card-price">
                            <span>${caseItem.price}</span>
                            <img src="stars.png" style="width:16px;height:16px;" alt="Coin">
                        </div>
                    </div>
                `;
                
                casesGrid.appendChild(caseElement);
            });
        }
        
        // Загрузка инвентаря
        function loadInventory() {
            const inventoryItems = document.getElementById('inventory-items');
            const emptyInventory = document.getElementById('empty-inventory');
            
            if (inventoryData.length === 0) {
                inventoryItems.style.display = 'none';
                emptyInventory.style.display = 'block';
            } else {
                inventoryItems.innerHTML = '';
                inventoryItems.style.display = 'grid';
                emptyInventory.style.display = 'none';
                
                inventoryData.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.innerHTML = `
                        <img src="${item.image}" class="inventory-item-image" alt="${item.name}">
                        <div class="inventory-item-name">${item.name}</div>
                        <div class="inventory-item-buttons">
                            <button class="inventory-btn withdraw" data-index="${index}">${translations[currentLanguage].withdraw_item}</button>
                            <button class="inventory-btn sell" data-index="${index}">${translations[currentLanguage].sell_item}</button>
                        </div>
                    `;
                    inventoryItems.appendChild(itemElement);
                });
            }
        }
        
        // Загрузка истории
        function loadHistory() {
            const historyItems = document.getElementById('history-items');
            const emptyHistory = document.getElementById('empty-history');
            
            if (historyData.length === 0) {
                historyItems.innerHTML = '';
                emptyHistory.style.display = 'flex';
            } else {
                historyItems.innerHTML = '';
                emptyHistory.style.display = 'none';
                
                historyData.forEach(record => {
                    const caseItem = casesDatabase.find(c => c.id === record.caseId);
                    const item = caseItem?.items.find(i => i.id === record.itemId) || { name: 'Неизвестный предмет', image: 'https://via.placeholder.com/50' };
                    
                    const historyElement = document.createElement('div');
                    historyElement.className = 'history-item';
                    historyElement.innerHTML = `
                        <img src="${item.image}" class="history-item-image" alt="${item.name}">
                        <div class="history-item-info">
                            <div class="history-item-name">${item.name}</div>
                            <div class="history-item-date">${new Date(record.date).toLocaleString()}</div>
                        </div>
                        <div class="history-item-price">
                            <span>${caseItem?.price || 0}</span>
                            <img src="stars.png" style="width:16px;height:16px;" alt="Coin">
                        </div>
                    `;
                    historyItems.appendChild(historyElement);
                });
            }
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Клик по кейсу
            document.addEventListener('click', function(e) {
                const card = e.target.closest('.card');
                if (card && !isSpinning) {
                    const caseId = parseInt(card.getAttribute('data-id'));
                    selectedCase = casesDatabase.find(c => c.id === caseId);
                    
                    if (selectedCase) {
                        openCaseModal(selectedCase);
                    }
                }
                
                // Обработка кнопок в инвентаре
                const sellBtn = e.target.closest('.inventory-btn.sell');
                if (sellBtn) {
                    const index = sellBtn.getAttribute('data-index');
                    sellInventoryItem(index);
                }
                
                const withdrawBtn = e.target.closest('.inventory-btn.withdraw');
                if (withdrawBtn) {
                    const index = withdrawBtn.getAttribute('data-index');
                    withdrawInventoryItem(index);
                }
            });
            
            // Кнопка пополнения
            document.getElementById('deposit-btn').addEventListener('click', function() {
                document.getElementById('payment-modal').style.display = 'flex';
            });
            
            document.getElementById('profile-deposit-btn').addEventListener('click', function() {
                document.getElementById('payment-modal').style.display = 'flex';
            });
            
            // Выбор суммы пополнения
            document.querySelectorAll('.amount-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.amount-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDepositAmount = parseInt(this.getAttribute('data-amount'));
                });
            });
            
            // Отмена платежа
            document.getElementById('cancel-payment').addEventListener('click', function() {
                document.getElementById('payment-modal').style.display = 'none';
            });
            
            // Подтверждение платежа
            document.getElementById('confirm-payment').addEventListener('click', function() {
                document.getElementById('payment-modal').style.display = 'none';
                processPayment(selectedDepositAmount);
            });
            
            // Закрытие модального окна кейса
            document.getElementById('close-case-modal').addEventListener('click', function() {
                if (!isSpinning) {
                    document.getElementById('case-modal').style.display = 'none';
                }
            });
            
            // Кнопка крутить
            document.getElementById('spin-btn').addEventListener('click', function() {
                if (!isSpinning && userBalance >= selectedCase.price) {
                    spinWheel();
                } else if (isSpinning) {
                    showNotification('Уже крутится!');
                } else {
                    showNotification('Недостаточно средств!');
                }
            });
            
            // Кнопки в окне выигранного предмета
            document.getElementById('sell-item').addEventListener('click', function() {
                // Продаем предмет за полную цену кейса
                const sellPrice = selectedCase.price;
                userBalance += sellPrice;
                updateBalance();
                
                showNotification(`Предмет продан за ${sellPrice} звезд!`);
                document.getElementById('won-item-modal').style.display = 'none';
                
                // Добавляем запись в историю
                const historyRecord = {
                    caseId: selectedCase.id,
                    caseName: selectedCase.name,
                    itemId: lastWonItem.id,
                    itemName: lastWonItem.name,
                    date: new Date().toISOString(),
                    price: sellPrice,
                    sold: true
                };
                
                historyData.unshift(historyRecord);
                localStorage.setItem('userHistory', JSON.stringify(historyData));
                
                if (currentSection === 'history-section') {
                    loadHistory();
                }
            });
            
            document.getElementById('keep-item').addEventListener('click', function() {
                // Добавляем предмет в инвентарь
                inventoryData.unshift({
                    ...lastWonItem,
                    caseId: selectedCase.id,
                    casePrice: selectedCase.price
                });
                localStorage.setItem('userInventory', JSON.stringify(inventoryData));
                
                document.getElementById('won-item-modal').style.display = 'none';
                
                // Добавляем запись в историю
                const historyRecord = {
                    caseId: selectedCase.id,
                    caseName: selectedCase.name,
                    itemId: lastWonItem.id,
                    itemName: lastWonItem.name,
                    date: new Date().toISOString(),
                    price: selectedCase.price,
                    sold: false
                };
                
                historyData.unshift(historyRecord);
                localStorage.setItem('userHistory', JSON.stringify(historyData));
                
                // Обновляем инвентарь и историю, если мы на соответствующих вкладках
                if (currentSection === 'inventory-section') {
                    loadInventory();
                } else if (currentSection === 'history-section') {
                    loadHistory();
                }
            });
            
            // Кнопка "Исправить" в пустом инвентаре
            document.getElementById('fix-inventory-btn').addEventListener('click', function() {
                switchSection('cases-section');
            });
            
            // Кнопка "Открыть кейс" в пустой истории
            document.getElementById('fix-history-btn').addEventListener('click', function() {
                switchSection('cases-section');
            });
            
            // Меню навигации
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchSection(tab);
                });
            });
            
            // Поиск кейсов
            document.getElementById('search-input').addEventListener('input', function() {
                filterCases(this.value.toLowerCase());
            });
            
            // Выбор языка
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.language-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    currentLanguage = this.textContent;
                    localStorage.setItem('userLanguage', currentLanguage);
                    applyLanguage();
                });
            });
        }
        
        // Переключение между разделами
        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`.menu-item[data-tab="${sectionId}"]`).classList.add('active');
            
            currentSection = sectionId;
            
            // Прокрутка вверх при переключении
            window.scrollTo(0, 0);
            
            // Обновляем данные при переходе
            if (sectionId === 'inventory-section') {
                loadInventory();
            } else if (sectionId === 'history-section') {
                loadHistory();
            }
        }
        
        // Фильтрация кейсов по поиску
        function filterCases(searchTerm) {
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const caseName = card.querySelector('.card-name').textContent.toLowerCase();
                if (caseName.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Открытие модального окна кейса
        function openCaseModal(caseData) {
            document.getElementById('case-modal-title').textContent = translations[currentLanguage].open_case;
            document.getElementById('spin-btn').innerHTML = `${translations[currentLanguage].open_for} <span id="spin-price">${caseData.price}</span> <img src="stars.png" style="width:16px;height:16px;" alt="Coin">`;
            
            // Обновляем состояние кнопки в зависимости от баланса
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = userBalance < caseData.price;
            
            // Заполняем рулетку
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            
            // Создаем расширенный список предметов с учетом шансов
            wheelItems = [];
            caseData.items.forEach(item => {
                if (item.chance > 0) { // Исключаем предметы с нулевым шансом
                    for (let i = 0; i < item.chance; i++) {
                        wheelItems.push(item);
                    }
                }
            });
            
            // Перемешиваем предметы
            shuffleArray(wheelItems);
            
            // Добавляем предметы в рулетку (3 полных цикла для анимации)
            for (let i = 0; i < 3; i++) {
                wheelItems.forEach(item => {
                    const wheelItem = document.createElement('div');
                    wheelItem.className = 'wheel-item';
                    wheelItem.innerHTML = `
                        <img src="${item.image}" class="wheel-item-image" alt="${item.name}">
                        <div class="wheel-item-name">${item.name}</div>
                    `;
                    wheel.appendChild(wheelItem);
                });
            }
            
            // Заполняем возможные предметы
            const possibleItemsContainer = document.getElementById('possible-items');
            possibleItemsContainer.innerHTML = '';
            
            // Уникальные предметы для отображения (только с ненулевым шансом)
            allPossibleItems = [...new Set(caseData.items.filter(item => item.chance > 0).map(item => item.id))]
                .map(id => caseData.items.find(item => item.id === id));
            
            allPossibleItems.forEach(item => {
                const possibleItem = document.createElement('div');
                possibleItem.className = 'possible-item';
                possibleItem.innerHTML = `
                    <img src="${item.image}" class="possible-item-image" alt="${item.name}">
                    <div class="possible-item-name">${item.name}</div>
                `;
                possibleItemsContainer.appendChild(possibleItem);
            });
            
            document.getElementById('case-modal').style.display = 'flex';
        }
        
        // Вращение рулетки с точной остановкой под ползунком
        function spinWheel() {
            if (isSpinning) return;
            
            isSpinning = true;
            userBalance -= selectedCase.price;
            updateBalance();
            
            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spin-btn');
            spinBtn.disabled = true;
            
            // Выбираем случайный предмет (с учетом шансов)
            let randomItem;
            if (selectedCase.id === 4) { // Star XCase - случайный выбор из 5 предметов
                randomItem = getRandomItem(selectedCase.items);
            } else {
                randomItem = getRandomItem(selectedCase.items.filter(item => item.chance > 0));
            }
            
            lastWonItem = randomItem; // Сохраняем выигранный предмет
            
            const itemIndex = wheelItems.findIndex(item => item.id === randomItem.id && item.name === randomItem.name);
            
            // Рассчитываем позицию для остановки под ползунком
            const itemWidth = 166; // Ширина элемента рулетки (150px + 16px margin)
            const containerWidth = wheel.parentElement.clientWidth;
            const containerCenter = containerWidth / 2;
            const itemCenter = (itemIndex * itemWidth) + (itemWidth / 2);
            
            // Вычисляем точное смещение для центрирования предмета под ползунком
            const targetPosition = containerCenter - itemCenter - (wheelItems.length * itemWidth);
            
            // Начальная позиция
            wheel.style.transition = 'none';
            wheel.style.transform = 'translateX(0)';
            
            // Запускаем анимацию в следующем кадре
            setTimeout(() => {
                wheel.style.transition = 'transform 4s cubic-bezier(0.1, 0.5, 0.3, 1)';
                wheel.style.transform = `translateX(${targetPosition}px)`;
            }, 50);
            
            // Завершение вращения
            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = userBalance < selectedCase.price;
                
                // Подсветка выигранного предмета
                highlightWonItem(randomItem);
                
                // Показываем выигранный предмет
                setTimeout(() => {
                    showWonItem(randomItem);
                }, 500);
            }, 4050);
        }
        
        // Подсветка выигранного предмета в рулетке
        function highlightWonItem(item) {
            const wheelItems = document.querySelectorAll('.wheel-item');
            wheelItems.forEach((wheelItem, index) => {
                const itemName = wheelItem.querySelector('.wheel-item-name').textContent;
                if (itemName === item.name) {
                    // Проверяем, находится ли предмет под ползунком
                    const itemRect = wheelItem.getBoundingClientRect();
                    const pointerRect = document.querySelector('.wheel-pointer').getBoundingClientRect();
                    
                    // Если центр предмета совпадает с центром ползунка (с погрешностью)
                    if (Math.abs(itemRect.left + itemRect.width/2 - pointerRect.left) < 10) {
                        wheelItem.classList.add('highlight');
                        setTimeout(() => {
                            wheelItem.classList.remove('highlight');
                        }, 1500);
                    }
                }
            });
        }
        
        // Показ выигранного предмета
        function showWonItem(item) {
            document.getElementById('won-item-image').src = item.image;
            document.getElementById('won-item-name').textContent = item.name;
            
            document.getElementById('won-item-modal').style.display = 'flex';
        }
        
        // Продажа предмета из инвентаря
        function sellInventoryItem(index) {
            const item = inventoryData[index];
            const sellPrice = item.casePrice; // Полная цена кейса
            
            userBalance += sellPrice;
            updateBalance();
            
            // Удаляем предмет из инвентаря
            inventoryData.splice(index, 1);
            localStorage.setItem('userInventory', JSON.stringify(inventoryData));
            
            // Обновляем инвентарь
            loadInventory();
            
            showNotification(`Предмет продан за ${sellPrice} звезд!`);
        }
        
        // Вывод предмета из инвентаря
        function withdrawInventoryItem(index) {
            showNotification('Функция вывода предмета в разработке');
        }
        
        // Обработка платежа через Telegram Stars
        function processPayment(amount) {
            if (!tgWebApp) {
                // Для локального тестирования
                const bonus = calculateBonus(amount);
                userBalance += amount + bonus;
                updateBalance();
                showNotification(`Баланс пополнен на ${amount + bonus} звезд!`);
                return;
            }
            
            // Создаем параметры для платежа
            const paymentParams = {
                title: `Пополнение на ${amount} звезд`,
                description: "Пополнение игрового баланса",
                photo_url: "https://via.placeholder.com/200x200/2D3947/FFFFFF?text=Deposit",
                photo_width: 200,
                photo_height: 200,
                prices: [{ label: `${amount} звезд`, amount: amount * 100 }], // amount в копейках
                currency: "XTR", // Telegram Stars
                payload: JSON.stringify({
                    userId: tgWebApp.initDataUnsafe.user?.id || 0,
                    amount: amount,
                    timestamp: Date.now()
                })
            };
            
            // Открываем платежный интерфейс
            tgWebApp.openInvoice(paymentParams, function(status) {
                if (status === 'paid') {
                    const bonus = calculateBonus(amount);
                    userBalance += amount + bonus;
                    updateBalance();
                    showNotification(`Баланс пополнен на ${amount + bonus} звезд!`);
                    
                    // Обновляем кнопку в модальном окне, если оно открыто
                    if (selectedCase) {
                        const spinBtn = document.getElementById('spin-btn');
                        spinBtn.disabled = userBalance < selectedCase.price;
                    }
                } else if (status === 'failed') {
                    showNotification('Оплата не прошла. Пожалуйста, попробуйте еще раз.');
                } else if (status === 'cancelled') {
                    showNotification('Оплата отменена.');
                }
            });
        }
        
        // Вспомогательные функции
        function getRandomItem(items) {
            const totalChance = items.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalChance;
            
            for (const item of items) {
                if (random < item.chance) {
                    return item;
                }
                random -= item.chance;
            }
            
            return items[0];
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function calculateBonus(amount) {
            if (amount >= 1000) return Math.floor(amount * 0.3);
            if (amount >= 500) return Math.floor(amount * 0.2);
            if (amount >= 200) return Math.floor(amount * 0.1);
            return 0;
        }
        
        function updateBalance() {
            document.getElementById('balance-value').textContent = userBalance;
            localStorage.setItem('userBalance', userBalance);
        }
        
        function showNotification(message) {
            if (tgWebApp) {
                tgWebApp.showAlert(message);
            } else {
                alert(message);
            }
        }
        
        // Запуск приложения
        initApp();
    </script>
</body>
</html>